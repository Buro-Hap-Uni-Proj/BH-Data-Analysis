---
title: "BH Analysis"
author: "Marc"
date: "28/02/2020"
output: html_document
---

FILTERED BY 18/12/19

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

Required Libraries:
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(data.table)
library(lubridate)
library(ggthemes)
library(pacman)
options(scipen = 999)
library(sp)
library(rgeos)
```

Getting File:
```{r}
#Depending on Computer:
setwd('/users/marckennedy/desktop')
getwd()
#setwd('/Users/Marc/Desktop')
BHData<-read.csv(file='BHDATA.csv')
#BHData
BH<-unique(BHData[ , 2:6])

```

Separating Position:
```{r}
BH<- data.frame(separate(BH,position, c("X", "Y"),","))
BH$X2<-as.numeric(gsub("\\[","",BH$X))
BH$Y2<-as.numeric(gsub("\\]","",BH$Y))
```

Converting Time:
```{r}
BH$datetime<-as.POSIXct((BH$time)/1000, origin="1970-01-01")
BH$date<- as.IDate(BH$datetime)
BH$time_of_day<-as.ITime(BH$datetime)
```

Tidying Up Data:
```{r}
BH$uuid<-NULL
BH$direction<-NULL
BH$X<- BH$X2
BH$Y<- BH$Y2
BH$X2<- NULL
BH$Y2<- NULL
```

Filtering for one day:
```{r}
TESTDATA<-subset(BH,date=="2019-12-18")
TESTDATA<- subset(TESTDATA, datetime>=as.POSIXct("2019-12-18 09:00:00") & datetime<=as.POSIXct("2019-12-18 17:00:00"))
```

Layout Plots:
```{r}
packs <- c("png","grid")
lapply(packs, require, character.only = TRUE) 
img <- readPNG("Layout.png") 
g <- rasterGrob(img, interpolate=TRUE) 
subset(TESTDATA, X=56)

ggplot(data = TESTDATA,aes(x= -Y,y=-X,color=time,group=irlynx_id))+
  scale_color_gradientn(colours = rainbow(10))+
  scale_x_continuous(limits = c(-555,110),breaks = seq(-555,110,50))+
  scale_y_continuous(limits = c(-550,-60),breaks = seq(-550,-60,50))+
  xlab("xpos")+
  ylab("ypos")+
  annotation_custom(g, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) +
  #geom_path(size=0.1)+
  geom_point(size=0.1)+
  theme(legend.position = "none")
```

1 UNIT = 0.052 m

Journey Time:
```{r}
maxtime<-data.frame(tapply(TESTDATA$datetime,TESTDATA$irlynx_id,max))
mintime<-data.frame(tapply(TESTDATA$datetime,TESTDATA$irlynx_id,min))
journeys<-merge(maxtime,mintime,by ="row.names")
journeys$irlynx_id<-journeys$Row.names
journeys$Row.names<-NULL
journeys$max<-journeys$tapply.TESTDATA.datetime..TESTDATA.irlynx_id..max.
journeys$tapply.TESTDATA.datetime..TESTDATA.irlynx_id..max.<-NULL
journeys$min<-journeys$tapply.TESTDATA.datetime..TESTDATA.irlynx_id..min.
journeys$tapply.TESTDATA.datetime..TESTDATA.irlynx_id..min.<-NULL
journeys$journeytime<-(journeys$max-journeys$min)
journeys<-subset(journeys,!is.na(journeytime))
sum(journeys$journeytime)/3600
journeys$journeytime_min<-(journeys$journeytime/60)
journeys$journeytime_h<-(journeys$journeytime/3600)
realjourneys<-subset(journeys,journeytime>0)
sum(realjourneys$journeytime_min)
realjourneys2<-subset(realjourneys,journeytime>5)
# ggplot(data=realjourneys2,aes(x=realjourneys2$journeytime))+geom_histogram(binwidth = 0.05)+scale_x_log10()
```

Number of Employees per timestamp:
```{r}
times<-group_by(TESTDATA,time)
timeinfo<-summarise(times,
                    n=n())
timeinfo$Ntime<-as.POSIXct((timeinfo$time)/1000, origin="1970-01-01")
timeinfo$Ntod <- as.ITime(timeinfo$Ntime)
timeinfo$Ndate <- as.IDate(timeinfo$Ntime)
timeinfo$date <- as.numeric(as.POSIXct(timeinfo$Ndate))
timeinfo$timeofday<-(timeinfo$time-timeinfo$date*1000)
summary(timeinfo$n)

```

Plot of ids vs time:
```{r}
ggplot(data=timeinfo,aes(x=(Ntod/3600),y=n))+
  geom_path()+
  scale_x_continuous(breaks = seq(0,24,1))+
  xlab("Time of Day /h ")+
  ylab("Number of Heat Sources")
```


Distance Travelled By ID:
```{r}
ID_Count <- group_by(TESTDATA, irlynx_id)
Counts <- summarise(ID_Count , n=n())
Relevant_ids <- filter (Counts, n >= 2)
list_ids <- as.character(Relevant_ids$irlynx_id)
list_ids <- unique(list_ids)

d_total <- 0
distances <- data_frame(ids = character(), distance = numeric())

for (k in list_ids) {
  one_dot <- filter (TESTDATA, irlynx_id==k)
  one_dot <- one_dot[order(one_dot$time),]
  imax <- nrow(one_dot) - 1
  d <- 0
    for(i in 1:imax) {
      d[i] <- sqrt( ((one_dot$X[i+1]-one_dot$X[i])*(one_dot$X[i+1]-one_dot$X[i]))+((one_dot$Y[i+1]-one_dot$Y[i])*(one_dot$Y[i+1]-one_dot$Y[i])))
    }
  d_total [k] <- sum(d, na.rm = FALSE)
  distances <- rbind(distances, data.frame(ids = k, distance = d_total[k]))
}
distances$distance_m<-distances$distance*0.052

max(distances$distance)
```

Plot of distances:
```{r}
ggplot(data=distances, aes(x=distance_m))+
  geom_histogram()
```

Combining time and distance:
```{r}
realdistance<-subset(distances,distances$distance>0)
time_distance<-merge(realdistance,realjourneys,by.x = "ids",by.y = "irlynx_id")
write.csv(time_distance,"BH_time_distance.csv")
time_distance$speed<-time_distance$distance_m/time_distance$journeytime
ggplot(data = time_distance, aes(x=speed))+
  geom_histogram(binwidth = 0.01)+
  xlim(0.8,1.5)
```

Journey info:
```{r}
goodtraces<-subset(time_distance, time_distance$speed<1.5)
goodtraces<-subset(time_distance, time_distance$speed>0.8)
summary(goodtraces$journeytime)
summary(goodtraces$distance_m)
summary(goodtraces$speed)
max(timeinfo$n)
sum(time_distance$journeytime_min)/max(timeinfo$n)
max(timeinfo$n)
```


```{r}
# setwd('/users/marckennedy/desktop')
# time_distance<-read.csv(file='BH_time_distance.csv')
# time_distance$speed<-time_distance$distance/time_distance$journeytime
# mean(time_distance$speed)
# median(time_distance$speed)
```


Test Plot of distance distribution:
```{r}
#ggplot(data = distances,aes(x=distance))+geom_histogram(bindwidth=10)
```

Neighbours Testing:
```{r}

# ntest<-subset(BH,time==1576666973854)
# sp.ntest<-ntest
# coordinates(sp.ntest) <- ~X+Y
# class(sp.ntest)
# d <- gDistance(sp.ntest, byid=T)
# min.d <- apply(d, 1, function(x) order(x, decreasing=F)[2])
# newdata <- cbind(ntest, ntest[min.d,], apply(d, 1, function(x) sort(x, decreasing=F)[2]))
# colnames(newdata) <- c(colnames(ntest),'neighbor irlynx_id','n.time','n.X','n.Y', '','','', 'distance')
```

